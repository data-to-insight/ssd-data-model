
WITH EXCLUSIONS AS (
	SELECT
		PV.PERSONID
	FROM PERSONVIEW PV
	WHERE PV.PERSONID IN (
			1,2,3,4,5,6,99046,100824,100825,100826,100827,100828,100829,100830,100832,100856,100857,100861,100864,9999040,102790,
			100831,100833,100834,100838,100839,100859,100860,99524,99543,99555,99559,99613,99661,99662,99993,100276,100290,100372,109032,100924,
			100941,35698,43088,68635,74902,77731,97447,9999000,9999010,9999025,9999026,9999029,9999050,72306,109032,117746,
			97951 --not flagged as duplicate
		)
		OR COALESCE(PV.DUPLICATED,'?') IN ('DUPLICATE')
		OR UPPER(PV.FORENAME) LIKE '%DUPLICATE%'
		OR UPPER(PV.SURNAME) LIKE '%DUPLICATE%'
)

SELECT
	CLA.PERSONID                    AS "disa_person_id", --metadata={"item_ref:"DISA001A"}
	CLA.CLASSIFICATIONASSIGNMENTID  AS "disa_table_id",  --metadata={"item_ref:"DISA003A"}
	CASE WHEN CLASSIFICATION.NAME = 'No disability' 
	         THEN 'NONE'
	     WHEN CLASSIFICATION.NAME = 'Mobility' 
	         THEN 'MOB'
	     WHEN CLASSIFICATION.NAME = 'Hand function' 
	         THEN 'HAND'
	     WHEN CLASSIFICATION.NAME = 'Personal care' 
	         THEN 'PC'
	     WHEN CLASSIFICATION.NAME = 'Incontinence' 
	         THEN 'INC'
	     WHEN CLASSIFICATION.NAME = 'Communication' 
	         THEN 'COMM'
	     WHEN CLASSIFICATION.NAME = 'Learning Disability'
	          OR  CLA.NAME = 'Learning'
	         THEN 'LD'
	     WHEN CLASSIFICATION.NAME = 'Hearing' 
	         THEN 'HEAR'    
	     WHEN CLASSIFICATION.NAME = 'Vision' 
	         THEN 'VIS' 
	     WHEN CLASSIFICATION.NAME = 'Behaviour' 
	         THEN 'BEH' 
	     WHEN CLASSIFICATION.NAME = 'Consciousness' 
	         THEN 'CON' 
	     WHEN CLASSIFICATION.NAME = 'Diagnosed autism/aspergers' 
	             OR CLASSIFICATION.NAME = 'Autistic Spectrum Disorder'
	             OR CLASSIFICATION.NAME = 'Autism spectrum condition'
	         THEN 'AUT' 
	         ELSE 'DDA'   
	END                             AS "disa_disability_code" --metadata={"item_ref:"DISA002A"}
	
FROM CLASSIFICATIONPERSONVIEW CLA
LEFT JOIN CLASSIFICATION ON CLASSIFICATION.ID = CLA.CLASSIFICATIONCODEID
WHERE CLA.STATUS NOT IN ('DELETED')
	AND CLA.CLASSIFICATIONPATHID IN (55, 58, 79, 172,186)
	AND CLA.PERSONID NOT IN (SELECT E.PERSONID FROM EXCLUSIONS E);
